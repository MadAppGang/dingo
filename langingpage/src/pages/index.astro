---
// Fetch real Dingo examples and pass to React App
import App from '../components/react/App';
import AuthStateListener from '../components/react/AuthStateListener';
import AuthError from '../components/react/AuthError';
import '../styles/global.css';
import '../styles/nav-classes.css'; // Explicit navigation classes for Tailwind v4
import '../styles/shiki-markdown.css'; // Server-rendered code and markdown styling
import { getCollection } from 'astro:content';
import { codeToHtml } from 'shiki';
import { marked } from 'marked';
import { dingoLanguage } from '../lib/dingoLanguage';
import { highlightMarkdownTokens } from '../lib/markdownHighlight';

// Fetch all golden examples
const allExamples = await getCollection('golden-examples');

// Sort by category_order first (showcase=0 appears first), then by order within category
const sortedExamples = allExamples.sort((a, b) => {
  // Primary sort: by category_order (showcase=0 is first)
  const categoryOrderA = a.data.category_order ?? 999; // Default to end if missing
  const categoryOrderB = b.data.category_order ?? 999;

  if (categoryOrderA !== categoryOrderB) {
    return categoryOrderA - categoryOrderB;
  }

  // Secondary sort: by example order within category
  return a.data.order - b.data.order;
});

// Pre-render code blocks and markdown on server using Shiki + marked
// This eliminates the need for react-syntax-highlighter and react-markdown
const formattedExamples = await Promise.all(
  sortedExamples.map(async (example, index) => {
    // Render code blocks with Shiki (server-side, zero JS)
    const beforeHtml = await codeToHtml(example.data.dingoCode, {
      lang: dingoLanguage as any,
      theme: 'dark-plus',
    });

    const afterHtml = await codeToHtml(example.data.goCode, {
      lang: 'go',
      theme: 'dark-plus',
    });

    // Render markdown with marked (server-side, zero JS)
    const reasoningSource = example.data.reasoning;
    const reasoningHtml = reasoningSource
      ? await (async () => {
          const tokens = marked.lexer(reasoningSource);
          await highlightMarkdownTokens(tokens);
          return marked.parser(tokens, {
            gfm: true,
            breaks: true,
          });
        })()
      : null;

    return {
      id: index + 1,
      title: example.data.title,
      language: 'go',
      description: example.data.description || `## ${example.data.category}\n\nExample showing ${example.data.title.toLowerCase()}.`,
      // Send pre-rendered HTML instead of raw code
      beforeHtml,
      afterHtml,
      reasoningHtml,
      // Metadata
      category: example.data.category,
      subcategory: example.data.subcategory,
      summary: example.data.summary,
      complexity: example.data.complexity,
      slug: example.id, // Use the collection ID as URL slug (e.g., "showcase_01_api_server")
    };
  })
);
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Primary Meta Tags -->
  <title>Dingo - A Meta-Language for Go</title>
  <meta name="title" content="Dingo - A meta-language for Go" />
  <meta name="description" content="Write better Go code with Result types, pattern matching, error propagation, and more. Dingo transpiles to idiomatic Go." />
  <link rel="canonical" href="https://dingolang.com/" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://dingolang.com/" />
  <meta property="og:title" content="Dingo - A meta-language for Go" />
  <meta property="og:description" content="Write better Go code with Result types, pattern matching, error propagation, and more. Transpiles to idiomatic Go." />
  <meta property="og:image" content="https://dingolang.com/og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:site_name" content="Dingo Lang" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://dingolang.com/" />
  <meta name="twitter:title" content="Dingo - A meta-language for Go" />
  <meta name="twitter:description" content="Write better Go code with Result types, pattern matching, error propagation, and more. Transpiles to idiomatic Go." />
  <meta name="twitter:image" content="https://dingolang.com/og-image.png" />
</head>
<body>
  <!-- Auth State Listener: client:load (CRITICAL - must run immediately) -->
  <!-- Reference: ai-docs/02-islands-architecture.md - Critical island -->
  <AuthStateListener client:load />

  <!-- Auth Error Display - Fixed top-center for visibility -->
  <div class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50">
    <AuthError client:load />
  </div>

  <!-- Pass real Dingo examples to React App -->
  <App examples={formattedExamples} client:load />
</body>
</html>
